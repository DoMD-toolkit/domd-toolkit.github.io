<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DoMD | TERMINAL v2.4</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --crt-green: #33ff33; --crt-blue: #33ccff; --bg-color: #0a0a0a; --crt-red: #ff3333; --crt-purple: #bb66ff; }
        body { background-color: var(--bg-color); color: var(--crt-green); font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.4; }
        .container { max-width: 1100px; margin-top: 2rem; border: 1px solid var(--crt-green); padding: 25px; box-shadow: 0 0 20px rgba(51, 255, 51, 0.15); margin-bottom: 80px; }
        h2 { border-bottom: 1px solid var(--crt-green); padding-bottom: 10px; text-transform: uppercase; letter-spacing: 2px; color: var(--crt-green); }
        
        .card { background: #111; border: 1px solid #333; margin-bottom: 20px; color: #ccc; border-radius: 0; }
        .card-header { background: #1a1a1a; border-bottom: 1px solid #333; color: var(--crt-blue); font-weight: bold; display: flex; justify-content: space-between; align-items: center; padding: 8px 15px; }
        
        .btn-crt { background: transparent; border: 1px solid var(--crt-green); color: var(--crt-green); border-radius: 0; transition: 0.2s; text-transform: uppercase; font-size: 11px; padding: 5px 12px; }
        .btn-crt:hover { background: var(--crt-green); color: #000; }
        .btn-blue { border-color: var(--crt-blue); color: var(--crt-blue); }
        .btn-blue:hover { background: var(--crt-blue); color: #000; }
        .btn-del { border-color: var(--crt-red); color: var(--crt-red); }
        .btn-del:hover { background: var(--crt-red); color: #fff; }
        
        .form-control { background: #000; border: 1px solid #444; color: var(--crt-green); border-radius: 0; margin-bottom: 5px; font-size: 13px; }
        .form-control:focus { background: #050505; color: var(--crt-green); border-color: var(--crt-blue); box-shadow: none; }
        
        .nav-tabs { border-bottom: 1px solid var(--crt-green); }
        .nav-tabs .nav-link { color: var(--crt-green); border: none; border-radius: 0; padding: 10px 20px; }
        .nav-tabs .nav-link.active { background: var(--crt-green); color: #000; font-weight: bold; }
        
        .pub-item, .help-item { border-left: 2px solid var(--crt-blue); padding: 12px 15px; margin-bottom: 15px; background: #0a0a0a; border-bottom: 1px solid #222; }
        .label-text { font-size: 11px; color: var(--crt-blue); text-transform: uppercase; display: block; margin-top: 8px; margin-bottom: 3px; font-weight: bold; }
        .desc-area { border-color: #225522; color: #88ff88; font-style: italic; margin-top: 5px; }
        
        .status-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #111; border-top: 1px solid var(--crt-green); padding: 5px 20px; font-size: 11px; z-index: 1000; }
    </style>
</head>
<body>

<div class="container">
    <h2>> DOMD_SYSTEM_DATA_TERMINAL_V2.4</h2>
    
    <div class="d-flex gap-2 my-4">
        <button class="btn btn-crt" onclick="fetchData()">[ 1. LOAD_REMOTE_DATA ]</button>
        <button class="btn btn-crt btn-blue" onclick="exportJSON()">[ 2. SYNC_AND_EXPORT ]</button>
    </div>

    <ul class="nav nav-tabs mb-4" id="mainTabs">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-news">NEWS</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-team">TEAM_CV</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-pub">PUBLICATIONS</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-help">HELP_DOCS</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="tab-news">
            <div id="news-list"></div>
            <button class="btn btn-crt mt-3" onclick="addNews()">+ ADD_NEWS_ENTRY</button>
        </div>

        <div class="tab-pane fade" id="tab-team">
            <div id="team-list"></div>
            <button class="btn btn-crt mt-3" onclick="addMember()">+ ADD_TEAM_MEMBER</button>
        </div>

        <div class="tab-pane fade" id="tab-pub">
            <div id="pub-list"></div>
            <button class="btn btn-crt mt-3" onclick="addPubGroup()">+ ADD_YEAR_GROUP</button>
        </div>

        <div class="tab-pane fade" id="tab-help">
            <div id="help-container"></div>
        </div>
    </div>
</div>

<div class="status-bar">
    SYSTEM_STATUS: <span id="sys-status">IDLE</span> | DATA_NODE: /contents/data.json
</div>

<script>
    let db = null;

    // --- 通用工具 ---
    function findNode(label) {
        return db.root.find(n => n.label === label);
    }

    // 解析双行论文逻辑
    function parsePubContent(content) {
        if (!content) return [];
        const rawEntries = content.trim().split(/\n(?=\d+\.)/);
        return rawEntries.map(entry => {
            const lines = entry.trim().split('\n');
            const meta = lines[0] || "";
            const desc = lines.slice(1).join('\n') || "";
            const obj = { metaRaw: meta, desc: desc, authors: '', journal: '', year: '', details: '' };
            
            // 匹配正则：数字. 作者, <italic>刊名</italic>, <bold>年份</bold>, 详情.
            const m = meta.match(/(?:\d+\.\s)?(.*),\s<span style='font-style: italic;'>(.*)<\/span>,\s<span style='font-weight: bold;'>(.*)<\/span>,\s(.*)\./);
            if(m) {
                obj.authors = m[1]; obj.journal = m[2]; obj.year = m[3]; obj.details = m[4];
            } else {
                obj.authors = meta.replace(/^\d+\.\s/, ""); // 兜底
            }
            return obj;
        });
    }

    function compilePubContent(pubs) {
        return pubs.map((p, i) => {
            let metaLine = `${i + 1}. ${p.authors}, <span style='font-style: italic;'>${p.journal}</span>, <span style='font-weight: bold;'>${p.year}</span>, ${p.details}.`;
            return p.desc ? `${metaLine}\n${p.desc}` : metaLine;
        }).join('\n');
    }

    // 解析 CV
    function parseCV(content) {
        const d = { name:'', role:'', photo:'', bio:'', email:'', pubs:[] };
        const nameM = content.match(/NAME:<\/span> (.*)\n/);
        const roleM = content.match(/ROLE:<\/span> (.*)\n/);
        const photoM = content.match(/\[\[IMG: (.*?) \|/);
        const bioM = content.match(/BIO:<\/span> (.*)\n/);
        const emailM = content.match(/Email:<\/span> (.*)\n/);
        if(nameM) d.name = nameM[1]; if(roleM) d.role = roleM[1]; if(photoM) d.photo = photoM[1];
        if(bioM) d.bio = bioM[1]; if(emailM) d.email = emailM[1];
        
        const parts = content.split("Publications:</span>");
        if(parts[1]) d.pubs = parsePubContent(parts[1]);
        return d;
    }

    // --- 核心操作 ---

    async function fetchData() {
        try {
            const res = await fetch('/contents/data.json');
            db = await res.json();
            renderAll();
            document.getElementById('sys-status').innerText = "READY";
        } catch(e) {
            console.error(e);
            alert("Error reading data.json. Check console.");
        }
    }

    function renderAll() {
        if(!db) return;
        renderNews(); renderTeam(); renderPubs(); renderHelp();
    }

    function renderNews() {
        const list = document.getElementById('news-list');
        list.innerHTML = db.sys.news.map((n, i) => `
            <div class="input-group mb-2">
                <input type="text" class="form-control" value="${n}" onchange="db.sys.news[${i}]=this.value">
                <button class="btn btn-del" onclick="db.sys.news.splice(${i},1);renderNews()">DEL</button>
            </div>
        `).join('');
    }

    function renderTeam() {
        const node = findNode("TEAM & CVs");
        const members = node.items[0].items;
        document.getElementById('team-list').innerHTML = members.map((m, i) => {
            const d = parseCV(m.content);
            return `<div class="card">
                <div class="card-header">CORE_MEMBER: ${m.label} <button class="btn btn-del" onclick="removeMember(${i})">REMOVE</button></div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <label class="label-text">UI_LABEL</label><input type="text" class="form-control" value="${m.label}" id="team-${i}-label">
                            <label class="label-text">NAME</label><input type="text" class="form-control" value="${d.name}" id="team-${i}-name">
                        </div>
                        <div class="col-md-6">
                            <label class="label-text">PHOTO_URL</label><input type="text" class="form-control" value="${d.photo}" id="team-${i}-photo">
                            <label class="label-text">EMAIL</label><input type="text" class="form-control" value="${d.email}" id="team-${i}-email">
                        </div>
                    </div>
                    <label class="label-text">ROLE</label><input type="text" class="form-control" value="${d.role}" id="team-${i}-role">
                    <label class="label-text">BIO_HTML</label><textarea class="form-control" id="team-${i}-bio">${d.bio}</textarea>
                    
                    <div class="mt-3">
                        <label class="label-text" style="color:var(--crt-purple)">CV_PUBLICATIONS</label>
                        <div id="team-${i}-pubs">${renderPubItemsUI(d.pubs, `team-${i}`)}</div>
                        <button class="btn btn-crt btn-blue mt-2" onclick="syncAll(); addPub('team', ${i})">+ ADD_PUB</button>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    function renderPubs() {
        const groups = findNode("PUBLICATIONS").items;
        document.getElementById('pub-list').innerHTML = groups.map((g, i) => `
            <div class="card">
                <div class="card-header">YEAR_GROUP: ${g.label} <button class="btn btn-del" onclick="removePubGroup(${i})">REMOVE</button></div>
                <div class="card-body">
                    <input type="text" class="form-control fw-bold" value="${g.label}" id="pubg-${i}-label">
                    <div id="pubg-${i}-pubs" class="mt-2">${renderPubItemsUI(parsePubContent(g.content), `pubg-${i}`)}</div>
                    <button class="btn btn-crt btn-blue mt-2" onclick="syncAll(); addPub('global', ${i})">+ ADD_PUB_TO_GROUP</button>
                </div>
            </div>
        `).join('');
    }

    function renderPubItemsUI(pubs, prefix) {
        return pubs.map((p, pi) => `
            <div class="pub-item">
                <div class="d-flex gap-2">
                    <input type="text" class="form-control" placeholder="Authors & Title" value="${p.authors}" id="${prefix}-p-${pi}-a">
                    <button class="btn btn-del" onclick="syncAll(); removePub('${prefix}', ${pi})">DEL</button>
                </div>
                <div class="d-flex gap-2">
                    <input type="text" class="form-control" placeholder="Journal" value="${p.journal}" id="${prefix}-p-${pi}-j">
                    <input type="text" class="form-control" style="width:90px" placeholder="Year" value="${p.year}" id="${prefix}-p-${pi}-y">
                    <input type="text" class="form-control" placeholder="Vol/Pages" value="${p.details}" id="${prefix}-p-${pi}-d">
                </div>
                <input type="text" class="form-control desc-area" placeholder="Description / Second Line" value="${p.desc}" id="${prefix}-p-${pi}-desc">
            </div>
        `).join('');
    }

    function renderHelp() {
        const help = findNode("HELP");
        const inst = help.items.find(x => x.label === "INSTALLATION");
        const tuts = help.items.find(x => x.label === "TOTURIALs"); // 匹配 JSON 里的拼写

        document.getElementById('help-container').innerHTML = `
            <div class="card">
                <div class="card-header">HELP >> INSTALLATION</div>
                <div class="card-body">
                    <textarea class="form-control" rows="10" id="help-inst-content">${inst.content}</textarea>
                </div>
            </div>
            <div class="card">
                <div class="card-header">HELP >> TOTURIALS (EXAMPLES)</div>
                <div class="card-body">
                    <div id="help-tut-list">
                        ${tuts.items.map((t, i) => `
                            <div class="help-item">
                                <div class="d-flex gap-2 mb-2">
                                    <input type="text" class="form-control fw-bold" value="${t.label}" id="tut-${i}-label">
                                    <button class="btn btn-del" onclick="syncAll(); removeTut(${i})">REMOVE</button>
                                </div>
                                <textarea class="form-control" rows="6" id="tut-${i}-content">${t.content}</textarea>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn btn-crt btn-blue mt-2" onclick="syncAll(); addTut()">+ ADD_EXAMPLE</button>
                </div>
            </div>
        `;
    }

    // --- 同步逻辑：非破坏性保留其他字段 ---

    function syncAll() {
        if(!db) return;

        // Sync News handled via direct onchange

        // Sync Team
        const teamItems = findNode("TEAM & CVs").items[0].items;
        teamItems.forEach((m, i) => {
            m.label = document.getElementById(`team-${i}-label`).value;
            const pubs = [];
            const pubDivs = document.getElementById(`team-${i}-pubs`).querySelectorAll('.pub-item');
            pubDivs.forEach((_, pi) => {
                pubs.push({
                    authors: document.getElementById(`team-${i}-p-${pi}-a`).value,
                    journal: document.getElementById(`team-${i}-p-${pi}-j`).value,
                    year: document.getElementById(`team-${i}-p-${pi}-y`).value,
                    details: document.getElementById(`team-${i}-p-${pi}-d`).value,
                    desc: document.getElementById(`team-${i}-p-${pi}-desc`).value
                });
            });
            m.content = `<span class='crt-blue'>NAME:</span> ${document.getElementById(`team-${i}-name`).value}\n` +
                        `<span class='crt-blue'>ROLE:</span> ${document.getElementById(`team-${i}-role`).value}\n` +
                        `[[IMG: ${document.getElementById(`team-${i}-photo`).value} | PHOTO | small ]]\n` +
                        `<span class='crt-blue'>BIO:</span> ${document.getElementById(`team-${i}-bio`).value}\n` +
                        `<span class='crt-blue'>Email:</span> ${document.getElementById(`team-${i}-email`).value}\n` +
                        `<span class='crt-blue'>Publications:</span>\n` + compilePubContent(pubs);
        });

        // Sync Publications
        const pubGroups = findNode("PUBLICATIONS").items;
        pubGroups.forEach((g, i) => {
            g.label = document.getElementById(`pubg-${i}-label`).value;
            const pubs = [];
            const pubDivs = document.getElementById(`pubg-${i}-pubs`).querySelectorAll('.pub-item');
            pubDivs.forEach((_, pi) => {
                pubs.push({
                    authors: document.getElementById(`pubg-${i}-p-${pi}-a`).value,
                    journal: document.getElementById(`pubg-${i}-p-${pi}-j`).value,
                    year: document.getElementById(`pubg-${i}-p-${pi}-y`).value,
                    details: document.getElementById(`pubg-${i}-p-${pi}-d`).value,
                    desc: document.getElementById(`pubg-${i}-p-${pi}-desc`).value
                });
            });
            g.content = compilePubContent(pubs);
        });

        // Sync Help
        const help = findNode("HELP");
        help.items.find(x => x.label === "INSTALLATION").content = document.getElementById('help-inst-content').value;
        const tuts = help.items.find(x => x.label === "TOTURIALs").items;
        tuts.forEach((t, i) => {
            t.label = document.getElementById(`tut-${i}-label`).value;
            t.content = document.getElementById(`tut-${i}-content`).value;
        });
    }

    // --- 操作函数 ---
    function addPub(type, idx) {
        let node = type === 'team' ? findNode("TEAM & CVs").items[0].items[idx] : findNode("PUBLICATIONS").items[idx];
        let d = type === 'team' ? parseCV(node.content) : { pubs: parsePubContent(node.content) };
        d.pubs.push({ authors:'', journal:'', year:'', details:'', desc:'' });
        if(type === 'team') {
            node.content = node.content.split("Publications:</span>")[0] + "Publications:</span>\n" + compilePubContent(d.pubs);
            renderTeam();
        } else {
            node.content = compilePubContent(d.pubs);
            renderPubs();
        }
    }
    
    function removePub(prefix, pi) {
        let idx = parseInt(prefix.split('-')[1]);
        let node = prefix.startsWith('team') ? findNode("TEAM & CVs").items[0].items[idx] : findNode("PUBLICATIONS").items[idx];
        let d = prefix.startsWith('team') ? parseCV(node.content) : { pubs: parsePubContent(node.content) };
        d.pubs.splice(pi, 1);
        if(prefix.startsWith('team')) {
            node.content = node.content.split("Publications:</span>")[0] + "Publications:</span>\n" + compilePubContent(d.pubs);
            renderTeam();
        } else {
            node.content = compilePubContent(d.pubs);
            renderPubs();
        }
    }

    function addTut() { findNode("HELP").items.find(x => x.label === "TOTURIALs").items.push({label:"New Example", type:"file", mode:"fast", content:""}); renderHelp(); }
    function removeTut(i) { findNode("HELP").items.find(x => x.label === "TOTURIALs").items.splice(i, 1); renderHelp(); }
    function addNews() { db.sys.news.unshift(`[${new Date().toISOString().split('T')[0]}] NEW_MESSAGE`); renderNews(); }
    function addMember() { findNode("TEAM & CVs").items[0].items.push({label:"New Member", type:"file", content:"NAME:</span> \nROLE:</span> \n[[IMG: # | PHOTO | small ]]\nBIO:</span> \nEmail:</span> \n"}); renderTeam(); }
    function removeMember(i) { findNode("TEAM & CVs").items[0].items.splice(i, 1); renderTeam(); }
    function addPubGroup() { findNode("PUBLICATIONS").items.push({label:"NEW GROUP", type:"file", mode:"fast", content:""}); renderPubs(); }
    function removePubGroup(i) { findNode("PUBLICATIONS").items.splice(i, 1); renderPubs(); }

    function exportJSON() {
        syncAll();
        const blob = new Blob([JSON.stringify(db, null, 2)], {type: "application/json"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "data.json";
        a.click();
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
